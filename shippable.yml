language: none

build:
  pre_ci:
    - docker build -t dncr-ci:0.1 ./shippable

  pre_ci_boot:
    image_name: dncr-ci
    image_tag: 0.1
    pull: false
    options: "-e HOME=/root"

  ci:
    - composer.phar self-update
    - composer.phar install
    - cp .env.dev .env
    - php artisan key:generate
    - mkdir -p shippable/testresults
    - mkdir -p shippable/codecoverage
    - phpunit --log-junit shippable/testresults/junit.xml --coverage-xml shippable/
    - cd frontend
    - npm update
    - npm run ci
    - cp -r codecoverage/* ../shippable/codecoverage/*
    - cp testresults/* ../shippable/testresults

  cache: true
  cache_dir_list:
    - $SHIPPABLE_BUILD_DIR/frontend/node_modules
    - $SHIPPABLE_BUILD_DIR/vendor

integrations:
  notifications:
    - integrationName: Shippable-Slack
      type: slack
      recipients:
        - '#services'
      branches:
        only:
          - develop
          - master
      on_success: always
      on_failure: always
      on_start: never
      on_pull_request: never
    - integrationName: email
      type: email
      on_success: never
      on_failure: never
      on_pull_request: never
